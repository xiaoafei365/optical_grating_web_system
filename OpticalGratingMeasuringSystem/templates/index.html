<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G45-L-P1Xå…‰æ …æµ‹é‡ç³»ç»Ÿ - Webç‰ˆ</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
        }
        
        /* æ ‡é¢˜æ æ ·å¼ - ä¸åŸç¨‹åºä¸€è‡´ */
        .title-bar {
            background-color: #2c3e50;
            color: white;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }
        
        .title-text {
            font-size: 18px;
            font-weight: bold;
        }
        
        .time-display {
            font-size: 12px;
            color: #ecf0f1;
        }
        
        /* æ§åˆ¶é¢æ¿æ ·å¼ */
        .control-panel {
            background-color: #ecf0f1;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
        }
        
        .control-btn {
            padding: 10px 20px;
            font-size: 12px;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            min-width: 120px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .control-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .control-btn:active {
            transform: scale(0.98);
        }
        
        .start-btn {
            background-color: #27ae60;
            color: white;
        }
        
        .stop-btn {
            background-color: #e74c3c;
            color: white;
        }
        
        .export-btn {
            background-color: #3498db;
            color: white;
        }
        
        .config-btn {
            background-color: #9b59b6;
            color: white;
        }
        
        .system-status {
            margin-left: auto;
            font-size: 12px;
            font-weight: bold;
            color: #27ae60;
        }
        
        /* é€‰æ‹©é¢æ¿æ ·å¼ */
        .selection-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin: 5px 10px;
            padding: 10px;
            border-radius: 4px;
        }
        
        .panel-title {
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .version-selector {
            padding: 10px;
        }

        .version-dropdown {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
        }

        .version-dropdown:focus {
            outline: none;
            border-color: #007bff;
        }

        .selection-row {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .version-section {
            flex: 0 0 200px;
        }

        .grating-section {
            flex: 1;
        }

        .selection-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .selection-btn {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            margin: 2px;
            font-size: 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            transition: all 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }

        .selection-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            border-color: #3498db;
        }

        .selection-btn:active {
            transform: scale(0.98);
        }

        .selection-btn.active {
            background-color: #3498db;
            color: white;
        }

        .selection-btn.active:hover {
            background-color: #2980b9;
        }
        
        /* çŠ¶æ€ä¿¡æ¯é¢æ¿ */
        .status-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin: 5px 10px;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .cpk-display {
            font-size: 14px;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .current-value, .spec-limits, .database-status {
            font-size: 12px;
        }

        .database-status {
            font-weight: bold;
            margin-left: auto;
        }

        /* CPKé¢æ¿æ ·å¼ */
        .cpk-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            margin: 5px 10px;
            padding: 15px;
            border-radius: 4px;
        }

        .cpk-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 10px;
        }

        .cpk-item {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .cpk-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .cpk-label {
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .cpk-value {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .cpk-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
        }

        .cpk-excellent { color: #27ae60; }
        .cpk-good { color: #f39c12; }
        .cpk-poor { color: #e74c3c; }

        .status-excellent { background-color: #d5f4e6; color: #27ae60; }
        .status-good { background-color: #fef9e7; color: #f39c12; }
        .status-poor { background-color: #fadbd8; color: #e74c3c; }
        
        /* å›¾è¡¨åŒºåŸŸ */
        .chart-area {
            padding: 10px;
            background-color: white;
            margin: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-height: 600px;
        }
        
        .chart-container {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            height: 280px;
            position: relative;
        }
        
        /* åº•éƒ¨çŠ¶æ€æ  */
        .status-bar {
            background-color: #34495e;
            color: white;
            height: 30px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 12px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        
        .connection-status {
            margin-left: auto;
        }
        
        /* æŠ¥è­¦æ ·å¼ */
        .alarm-message {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            margin: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <!-- æ ‡é¢˜æ  - ä¸åŸç¨‹åºå¸ƒå±€å®Œå…¨ä¸€è‡´ -->
    <div class="title-bar">
        <div class="title-text">G45-L-P1Xå…‰æ …æµ‹é‡ç³»ç»Ÿ - Webç‰ˆ</div>
        <div class="time-display" id="timeDisplay"></div>
    </div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel">
        <button class="control-btn start-btn" id="startBtn">å¼€å§‹æµ‹é‡</button>
        <button class="control-btn stop-btn" id="stopBtn" disabled>åœæ­¢æµ‹é‡</button>
        <button class="control-btn export-btn" id="exportBtn">å¯¼å‡ºæ•°æ®</button>
        <button class="control-btn config-btn" id="configBtn">å‚æ•°è®¾ç½®</button>
        <div class="system-status" id="systemStatus">ç³»ç»Ÿå°±ç»ª</div>
    </div>
    
    <!-- ç‰ˆæœ¬å’Œç£æ …å°ºé€‰æ‹©é¢æ¿ -->
    <div class="selection-panel">
        <div class="selection-row">
            <!-- ç‰ˆæœ¬é€‰æ‹© -->
            <div class="version-section">
                <div class="panel-title">ç‰ˆæœ¬é€‰æ‹©</div>
                <select id="versionSelect" class="version-dropdown">
                    <!-- ç‰ˆæœ¬é€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
                </select>
            </div>
            
            <!-- ç£æ …å°ºé€‰æ‹© -->
            <div class="grating-section">
                <div class="panel-title">ç£æ …å°ºé€‰æ‹©</div>
                <div class="selection-buttons" id="gratingButtons">
                    <!-- æŒ‰é’®å°†æ ¹æ®ç‰ˆæœ¬åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€ä¿¡æ¯é¢æ¿ -->
    <div class="status-panel">
        <div class="cpk-display" id="cpkDisplay">CPK: --</div>
        <div class="current-value" id="currentValue">å½“å‰å€¼: --</div>
        <div class="spec-limits" id="specLimits">è§„æ ¼é™: --</div>
        <button class="control-btn cpk-btn" id="cpkBtn" style="background-color: #8e44ad; color: white; margin-left: 20px;">CPKè¶‹åŠ¿</button>
        <div class="database-status" id="databaseStatus">æ•°æ®åº“: æ£€æŸ¥ä¸­...</div>
        <div class="connection-details" id="connectionDetails">è¿æ¥çŠ¶æ€: åˆå§‹åŒ–ä¸­...</div>
    </div>

    <!-- CPKè¯¦ç»†é¢æ¿ (é»˜è®¤éšè—) -->
    <div class="cpk-panel" id="cpkPanel" style="display: none;">
        <div class="panel-title">CPKèƒ½åŠ›æŒ‡æ•°ç›‘æ§ - <span id="cpkSideIndicator">Lä¾§</span></div>
        <div class="cpk-grid">
            <div class="cpk-item">
                <div class="cpk-label" id="labelP1">L-P1</div>
                <div class="cpk-value" id="cpkP1">--</div>
                <div class="cpk-status" id="statusP1">--</div>
            </div>
            <div class="cpk-item">
                <div class="cpk-label" id="labelP5U">L-P5U</div>
                <div class="cpk-value" id="cpkP5U">--</div>
                <div class="cpk-status" id="statusP5U">--</div>
            </div>
            <div class="cpk-item">
                <div class="cpk-label" id="labelP5L">L-P5L</div>
                <div class="cpk-value" id="cpkP5L">--</div>
                <div class="cpk-status" id="statusP5L">--</div>
            </div>
            <div class="cpk-item">
                <div class="cpk-label" id="labelP3">L-P3</div>
                <div class="cpk-value" id="cpkP3">--</div>
                <div class="cpk-status" id="statusP3">--</div>
            </div>
            <div class="cpk-item">
                <div class="cpk-label" id="labelP4">L-P4</div>
                <div class="cpk-value" id="cpkP4">--</div>
                <div class="cpk-status" id="statusP4">--</div>
            </div>
        </div>
    </div>
    
    <!-- æŠ¥è­¦åŒºåŸŸ -->
    <div id="alarmArea"></div>
    
    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="chart-area" id="chartArea">
        <!-- å›¾è¡¨å°†åŠ¨æ€ç”Ÿæˆ -->
    </div>
    
    <!-- åº•éƒ¨çŠ¶æ€æ  -->
    <div class="status-bar">
        <span id="statusText">ç³»ç»Ÿå°±ç»ª</span>
        <span class="connection-status" id="connectionStatus">æœªè¿æ¥</span>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let charts = {};
        let currentGrating = '';
        let currentVersion = 'G45';
        let isRunning = false;

        // ç£æ …å°ºå‚æ•°æ˜ å°„
        const gratingParams = {
            'G45_Channel_1_L': ['x1', 'x2', 't'],
            'G45_Channel_2_L': ['m13m9', 'p3lt'],
            'G45_Channel_3_L': ['p3ut'],
            'G45_Channel_4_L': ['m6m8', 'p5t'],
            'G45_Channel_5_L': ['p4'],
            'G45_Channel_1_R': ['x1', 'x2', 't'],
            'G45_Channel_2_R': ['m13m9', 'p3lt'],
            'G45_Channel_3_R': ['p3ut'],
            'G45_Channel_4_R': ['m6m8', 'p5t'],
            'G45_Channel_5_R': ['p4'],
            'G48_Channel_1_L': ['x1', 'x2', 't'],
            'G48_Channel_2_L': ['m13m9', 'p3lt'],
            'G48_Channel_3_L': ['p3ut'],
            'G48_Channel_4_L': ['m6m8', 'p5t'],
            'G48_Channel_5_L': ['p4'],
            'G48_Channel_1_R': ['x1', 'x2', 't'],
            'G48_Channel_2_R': ['m13m9', 'p3lt'],
            'G48_Channel_3_R': ['p3ut'],
            'G48_Channel_4_R': ['m6m8', 'p5t'],
            'G48_Channel_5_R': ['p4']
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeEventListeners();
            loadVersions();
            checkDatabaseStatus();

            updateTimeDisplay();
            setInterval(updateTimeDisplay, 1000);

            // åˆå§‹åŒ–æ•°æ®æºçŠ¶æ€æ˜¾ç¤º
            updateDataSourceStatus();

            // å®šæœŸæ£€æŸ¥æ•°æ®åº“è¿æ¥çŠ¶æ€ (æ¯30ç§’)
            setInterval(checkDatabaseStatus, 30000);
        });

        // æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
        function checkDatabaseStatus() {
            const statusElement = document.getElementById('databaseStatus');
            const detailsElement = document.getElementById('connectionDetails');

            fetch('/api/get_database_info')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        if (data.database_available) {
                            statusElement.textContent = `æ•°æ®åº“: å·²è¿æ¥ (${data.table_count}ä¸ªè¡¨)`;
                            statusElement.style.color = '#27ae60';

                            // æ˜¾ç¤ºè¯¦ç»†è¿æ¥ä¿¡æ¯
                            const g45Tables = data.tables.filter(t => t.includes('G45')).length;
                            const g48Tables = data.tables.filter(t => t.includes('G48')).length;
                            detailsElement.textContent = `G45è¡¨: ${g45Tables}ä¸ª | G48è¡¨: ${g48Tables}ä¸ª | æ•°æ®æº: å®æ—¶æ•°æ®åº“`;
                            detailsElement.style.color = '#27ae60';

                            console.log('æ•°æ®åº“å¯ç”¨ï¼Œè¡¨åˆ—è¡¨:', data.tables);
                        } else {
                            statusElement.textContent = 'æ•°æ®åº“: ä¸å¯ç”¨';
                            statusElement.style.color = '#f39c12';
                            detailsElement.textContent = 'è¿æ¥çŠ¶æ€: ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ® | æ•°æ®æº: ç®—æ³•ç”Ÿæˆ';
                            detailsElement.style.color = '#f39c12';
                        }
                    } else {
                        statusElement.textContent = 'æ•°æ®åº“: è¿æ¥å¤±è´¥';
                        statusElement.style.color = '#e74c3c';
                        detailsElement.textContent = `è¿æ¥çŠ¶æ€: é”™è¯¯ - ${data.message || 'æœªçŸ¥é”™è¯¯'}`;
                        detailsElement.style.color = '#e74c3c';
                    }
                })
                .catch(error => {
                    console.error('æ£€æŸ¥æ•°æ®åº“çŠ¶æ€å¤±è´¥:', error);
                    statusElement.textContent = 'æ•°æ®åº“: æ£€æŸ¥å¤±è´¥';
                    statusElement.style.color = '#e74c3c';
                    detailsElement.textContent = `è¿æ¥çŠ¶æ€: ç½‘ç»œé”™è¯¯ - ${error.message}`;
                    detailsElement.style.color = '#e74c3c';
                });
        }

        // åŠ è½½ç‰ˆæœ¬ä¿¡æ¯
        function loadVersions() {
            fetch('/api/get_versions')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const versionSelect = document.getElementById('versionSelect');
                        versionSelect.innerHTML = '';
                        
                        data.versions.forEach(version => {
                            const option = document.createElement('option');
                            option.value = version;
                            option.textContent = version;
                            option.selected = version === data.current_version;
                            versionSelect.appendChild(option);
                        });
                        
                        currentVersion = data.current_version;
                        
                        // ç«‹å³æ›´æ–°é¡µé¢æ ‡é¢˜
                        updatePageTitle(currentVersion);
                        
                        // ç”ŸæˆæŒ‰é’®
                        generateGratingButtons(currentVersion);
                        
                        // è®¾ç½®é»˜è®¤é€‰æ‹©
                        const defaultGrating = `${currentVersion}_Channel_1_L`;
                        selectGrating(defaultGrating);
                        
                        console.log(`åˆå§‹ç‰ˆæœ¬åŠ è½½: ${currentVersion}`);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç‰ˆæœ¬å¤±è´¥:', error);
                    // ä½¿ç”¨é»˜è®¤ç‰ˆæœ¬
                    currentVersion = 'G45';
                    updatePageTitle(currentVersion);
                    generateGratingButtons(currentVersion);
                    selectGrating('G45_Channel_1_L');
                });
        }

        // ç”Ÿæˆç£æ …å°ºé€‰æ‹©æŒ‰é’®
        function generateGratingButtons(version) {
            const gratingButtons = document.getElementById('gratingButtons');
            gratingButtons.innerHTML = '';
            
            // å·¦ä¾§æŒ‰é’® (L)
            const leftButtons = [
                { channel: 1, name: 'P1' },
                { channel: 2, name: 'P5L' },
                { channel: 3, name: 'P5U' },
                { channel: 4, name: 'P3' },
                { channel: 5, name: 'P4' }
            ];
            
            // å³ä¾§æŒ‰é’® (R)
            const rightButtons = [
                { channel: 1, name: 'P1' },
                { channel: 2, name: 'P5L' },
                { channel: 3, name: 'P5U' },
                { channel: 4, name: 'P3' },
                { channel: 5, name: 'P4' }
            ];
            
            // ç”Ÿæˆå·¦ä¾§æŒ‰é’®
            leftButtons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'selection-btn';
                button.dataset.grating = `${version}_Channel_${btn.channel}_L`;
                button.textContent = `${version}-L-${btn.name}`;
                gratingButtons.appendChild(button);
            });

            // ç”Ÿæˆå³ä¾§æŒ‰é’®
            rightButtons.forEach(btn => {
                const button = document.createElement('button');
                button.className = 'selection-btn';
                button.dataset.grating = `${version}_Channel_${btn.channel}_R`;
                button.textContent = `${version}-R-${btn.name}`;
                gratingButtons.appendChild(button);
            });
        }

        // ç‰ˆæœ¬é€‰æ‹©å˜åŒ–å¤„ç†
        function onVersionChange() {
            const versionSelect = document.getElementById('versionSelect');
            const selectedVersion = versionSelect.value;
            
            console.log(`ç‰ˆæœ¬åˆ‡æ¢: ${currentVersion} -> ${selectedVersion}`);
            
            // ä¿å­˜ç‰ˆæœ¬é€‰æ‹©åˆ°åç«¯
            fetch('/api/set_version', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ version: selectedVersion })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // æ›´æ–°å…¨å±€å˜é‡
                    currentVersion = selectedVersion;
                    
                    // ç«‹å³æ›´æ–°é¡µé¢æ ‡é¢˜
                    updatePageTitle(selectedVersion);
                    
                    // é‡æ–°ç”Ÿæˆç£æ …å°ºæŒ‰é’®
                    generateGratingButtons(selectedVersion);
                    
                    // é€‰æ‹©æ–°ç‰ˆæœ¬çš„ç¬¬ä¸€ä¸ªé€šé“
                    const defaultGrating = `${selectedVersion}_Channel_1_L`;
                    selectGrating(defaultGrating);

                    // å¦‚æœCPKé¢æ¿æ˜¯æ‰“å¼€çš„ï¼Œæ›´æ–°CPKå€¼
                    const cpkPanel = document.getElementById('cpkPanel');
                    if (cpkPanel && cpkPanel.style.display !== 'none') {
                        console.log('ç‰ˆæœ¬åˆ‡æ¢æ—¶æ›´æ–°CPKå€¼');
                        setTimeout(() => {
                            updateAllCPKValues();
                        }, 500); // å»¶è¿Ÿ500msç¡®ä¿æ•°æ®åŠ è½½å®Œæˆ
                    }

                    // æ›´æ–°çŠ¶æ€é¢æ¿ä¸­çš„CPKæ˜¾ç¤º
                    setTimeout(() => {
                        updateStatusCPK();
                    }, 300);

                    console.log(`ç‰ˆæœ¬å·²æˆåŠŸåˆ‡æ¢åˆ°: ${selectedVersion}`);
                } else {
                    console.error('ä¿å­˜ç‰ˆæœ¬å¤±è´¥:', data.message);
                    // æ¢å¤åˆ°åŸæ¥çš„é€‰æ‹©
                    versionSelect.value = currentVersion;
                }
            })
            .catch(error => {
                console.error('ä¿å­˜ç‰ˆæœ¬å¤±è´¥:', error);
                // æ¢å¤åˆ°åŸæ¥çš„é€‰æ‹©
                versionSelect.value = currentVersion;
            });
        }

        // Socket.IOåˆå§‹åŒ–
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                document.getElementById('connectionStatus').textContent = 'å·²è¿æ¥';
                document.getElementById('connectionStatus').style.color = '#27ae60';
            });
            
            socket.on('disconnect', function() {
                document.getElementById('connectionStatus').textContent = 'è¿æ¥æ–­å¼€';
                document.getElementById('connectionStatus').style.color = '#e74c3c';
            });
            
            socket.on('measurement_update', function(data) {
                if (data.channel === currentChannel) {
                    updateChart();
                    updateStatusDisplay(data.data);
                }
                updateStatusText(`é€šé“${data.channel}æ•°æ®æ›´æ–° - ${new Date().toLocaleTimeString()}`);
            });
            
            socket.on('alarm', function(data) {
                showAlarm(data.message);
            });
        }
        
        // äº‹ä»¶ç›‘å¬å™¨åˆå§‹åŒ–
        function initializeEventListeners() {
            // å¼€å§‹æµ‹é‡æŒ‰é’®
            document.getElementById('startBtn').addEventListener('click', function() {
                fetch('/api/start_measurement', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            isRunning = true;
                            document.getElementById('startBtn').disabled = true;
                            document.getElementById('stopBtn').disabled = false;
                            document.getElementById('systemStatus').textContent = 'æµ‹é‡ä¸­...';
                            document.getElementById('systemStatus').style.color = '#f39c12';
                        }
                    });
            });
            
            // åœæ­¢æµ‹é‡æŒ‰é’®
            document.getElementById('stopBtn').addEventListener('click', function() {
                fetch('/api/stop_measurement', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            isRunning = false;
                            document.getElementById('startBtn').disabled = false;
                            document.getElementById('stopBtn').disabled = true;
                            document.getElementById('systemStatus').textContent = 'å·²åœæ­¢';
                            document.getElementById('systemStatus').style.color = '#e74c3c';
                        }
                    });
            });
            
            // å¯¼å‡ºæ•°æ®æŒ‰é’®
            document.getElementById('exportBtn').addEventListener('click', function() {
                fetch('/api/export_data')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert(`æ•°æ®å·²å¯¼å‡ºåˆ° ${data.filename}`);
                        } else {
                            alert(`å¯¼å‡ºå¤±è´¥: ${data.message}`);
                        }
                    });
            });
            
            // ç£æ …å°ºé€‰æ‹©æŒ‰é’®
            document.getElementById('gratingButtons').addEventListener('click', function(e) {
                if (e.target.classList.contains('selection-btn')) {
                    selectGrating(e.target.dataset.grating);
                }
            });
            
            // å‚æ•°è®¾ç½®æŒ‰é’®
            document.getElementById('configBtn').addEventListener('click', function() {
                window.open('/config', '_blank', 'width=1200,height=800');
            });

            // CPKè¶‹åŠ¿æŒ‰é’®
            document.getElementById('cpkBtn').addEventListener('click', function() {
                const cpkPanel = document.getElementById('cpkPanel');
                const isVisible = cpkPanel.style.display !== 'none';

                if (isVisible) {
                    cpkPanel.style.display = 'none';
                    this.textContent = 'CPKè¶‹åŠ¿';
                } else {
                    cpkPanel.style.display = 'block';
                    this.textContent = 'éšè—CPK';
                    // ç«‹å³æ›´æ–°æ ‡ç­¾å’Œæ•°æ®
                    const currentSide = getCurrentSide();
                    updateCPKLabels(currentSide);
                    updateAllCPKValues();
                }
            });

            // ç‰ˆæœ¬é€‰æ‹©ä¸‹æ‹‰æ¡†
            document.getElementById('versionSelect').addEventListener('change', onVersionChange);
        }
        
        // ç£æ …å°ºé€‰æ‹©
        function selectGrating(grating) {
            currentGrating = grating;
            
            console.log(`é€‰æ‹©ç£æ …å°º: ${grating}`);
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('#gratingButtons .selection-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.grating === grating);
            });
            
            // é‡æ–°åˆ›å»ºå›¾è¡¨
            createChartsForGrating(grating);
            
            // æ›´æ–°é¡µé¢æ ‡é¢˜ä»¥åæ˜ å½“å‰é€‰æ‹©
            const parts = grating.split('_');
            if (parts.length >= 4) {
                const version = parts[0]; // G45 æˆ– G48
                const channelNum = parts[2]; // 1
                const side = parts[3]; // L æˆ– R

                // æ ¹æ®é€šé“å·ç¡®å®šå‚æ•°å
                const channelNames = ['P1', 'P5L', 'P5U', 'P3', 'P4'];
                const paramName = channelNames[parseInt(channelNum) - 1] || 'P1';

                updateGratingTitle(`${version}-${side}-${paramName}`);

                // æ›´æ–°çŠ¶æ€é¢æ¿ä¸­çš„CPKæ˜¾ç¤º
                setTimeout(() => {
                    updateStatusCPK();
                }, 300);

                // å¦‚æœCPKé¢æ¿æ˜¯æ‰“å¼€çš„ï¼Œæ›´æ–°CPKå€¼
                const cpkPanel = document.getElementById('cpkPanel');
                if (cpkPanel && cpkPanel.style.display !== 'none') {
                    setTimeout(() => {
                        updateAllCPKValues();
                    }, 500);
                }
            }
        }
        
        // ä¸ºæŒ‡å®šç£æ …å°ºåˆ›å»ºå›¾è¡¨
        async function createChartsForGrating(grating) {
            const chartArea = document.getElementById('chartArea');
            chartArea.innerHTML = ''; // æ¸…ç©ºç°æœ‰å›¾è¡¨
            charts = {}; // é‡ç½®å›¾è¡¨å¯¹è±¡
            
            const params = gratingParams[grating] || [];
            
            // åˆ›å»ºå›¾è¡¨å®¹å™¨
            for (const param of params) {
                // å¹³å‡å€¼å›¾è¡¨
                const avgContainer = document.createElement('div');
                avgContainer.className = 'chart-container';
                avgContainer.style.width = '48%';
                avgContainer.style.display = 'inline-block';
                avgContainer.style.margin = '1%';
                
                const avgCanvas = document.createElement('canvas');
                avgCanvas.id = `chart_${param}_avg`;
                avgContainer.appendChild(avgCanvas);
                chartArea.appendChild(avgContainer);
                
                // æå·®å€¼å›¾è¡¨
                const ragContainer = document.createElement('div');
                ragContainer.className = 'chart-container';
                ragContainer.style.width = '48%';
                ragContainer.style.display = 'inline-block';
                ragContainer.style.margin = '1%';
                
                const ragCanvas = document.createElement('canvas');
                ragCanvas.id = `chart_${param}_rag`;
                ragContainer.appendChild(ragCanvas);
                chartArea.appendChild(ragContainer);
                
                // åˆ›å»ºChart.jså›¾è¡¨
                await createChart(`chart_${param}_avg`, param, 'å¹³å‡å€¼');
                await createChart(`chart_${param}_rag`, param, 'æå·®å€¼');
            }
        }
        
        // åˆ›å»ºå•ä¸ªå›¾è¡¨ - ç»Ÿä¸€ç‰ˆæœ¬
        async function createChart(canvasId, param, type) {
            const ctx = document.getElementById(canvasId).getContext('2d');

            // è·å–é…ç½®å‚æ•°
            const config = await getChartConfig(param, type);

            // è·å–æ•°æ®åº“æ•°æ®
            const chartData = await getChartDataFromDB(param, type);

            // å¤„ç†æ•°æ®ï¼šå¦‚æœæ˜¯ç©ºæ•°ç»„ï¼Œæ˜¾ç¤ºç©ºå›¾è¡¨ï¼›å¦‚æœæ˜¯nullï¼Œä½¿ç”¨é»˜è®¤å€¼
            let displayData;
            let dataSource = 'default';

            if (Array.isArray(chartData)) {
                if (chartData.length === 0) {
                    // æ•°æ®åº“è¿æ¥å¤±è´¥æˆ–æ— æ•°æ®ï¼Œæ˜¾ç¤ºç©ºå›¾è¡¨
                    displayData = [];
                    dataSource = 'empty';
                } else {
                    // æœ‰çœŸå®æ•°æ®
                    displayData = chartData;
                    dataSource = 'database';
                }
            } else {
                // chartDataä¸ºnullï¼Œä½¿ç”¨é»˜è®¤æ¨¡æ‹Ÿæ•°æ®
                displayData = Array(25).fill(config.baseValue);
                dataSource = 'simulation';
            }

            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 25}, (_, i) => i + 1),
                    datasets: [{
                        label: `${param.toUpperCase()} ${type} ${dataSource === 'empty' ? '(æ— æ•°æ®)' : ''}`,
                        data: displayData,
                        borderColor: dataSource === 'empty' ? '#95a5a6' : '#2ecc71',
                        backgroundColor: dataSource === 'empty' ? 'rgba(149, 165, 166, 0.1)' : 'rgba(46, 204, 113, 0.1)',
                        borderWidth: 2,
                        pointRadius: dataSource === 'empty' ? 0 : 3,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${param.toUpperCase()} - ${type}`,
                            font: {
                                size: 14,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'æµ‹é‡ç‚¹'
                            },
                            min: 1,
                            max: 25
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'æµ‹é‡å€¼'
                            },
                            min: config.yMin,
                            max: config.yMax
                        }
                    },
                    animation: {
                        duration: 0
                    }
                },
                plugins: [{
                    id: `referenceLines_${canvasId}`,
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        const chartArea = chart.chartArea;
                        const yScale = chart.scales.y;
                        
                        ctx.save();
                        
                        // å¯¹æ‰€æœ‰å›¾è¡¨æ˜¾ç¤ºå‚è€ƒçº¿ï¼ˆå¹³å‡å€¼å’Œæå·®å€¼éƒ½æ˜¾ç¤ºï¼‰
                        // è“è‰²è®¾å®šå€¼çº¿
                        if (config.baseValue !== undefined) {
                            const baseY = yScale.getPixelForValue(config.baseValue);
                            ctx.strokeStyle = '#3498db';
                            ctx.lineWidth = 2;
                            ctx.setLineDash([5, 5]);
                            ctx.beginPath();
                            ctx.moveTo(chartArea.left, baseY);
                            ctx.lineTo(chartArea.right, baseY);
                            ctx.stroke();
                        }
                        
                        // çº¢è‰²ä¸Šé™çº¿
                        if (config.upperAlarm !== undefined) {
                            const upperY = yScale.getPixelForValue(config.upperAlarm);
                            ctx.strokeStyle = '#e74c3c';
                            ctx.lineWidth = 2;
                            ctx.setLineDash([]);
                            ctx.beginPath();
                            ctx.moveTo(chartArea.left, upperY);
                            ctx.lineTo(chartArea.right, upperY);
                            ctx.stroke();
                        }
                        
                        // çº¢è‰²ä¸‹é™çº¿
                        if (config.lowerAlarm !== undefined) {
                            const lowerY = yScale.getPixelForValue(config.lowerAlarm);
                            ctx.strokeStyle = '#e74c3c';
                            ctx.lineWidth = 2;
                            ctx.setLineDash([]);
                            ctx.beginPath();
                            ctx.moveTo(chartArea.left, lowerY);
                            ctx.lineTo(chartArea.right, lowerY);
                            ctx.stroke();
                        }
                        
                        ctx.restore();
                    }
                }]
            });
            
            charts[canvasId] = chart;
        }
        
        // è·å–å›¾è¡¨é…ç½®å‚æ•°
        function getChartConfig(param, type) {
            // ä»åç«¯APIè·å–å®é™…é…ç½®æ•°æ®
            // å°† G45_Channel_1_L è½¬æ¢ä¸º G45_Channel_1 (åç«¯ä¸åŒºåˆ†L/R)
            const channel = currentGrating.replace(/_[LR]$/, '');
            return fetch(`/api/get_chart_config/${channel}/${param}/${type}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('è·å–å›¾è¡¨é…ç½®å¤±è´¥:', data.error);
                        // è¿”å›é»˜è®¤é…ç½®
                        return {
                            yMin: 0, yMax: 100, baseValue: 50, upperAlarm: 80, lowerAlarm: 20
                        };
                    }
                    return {
                        yMin: data.yMin,
                        yMax: data.yMax,
                        baseValue: data.baseValue,
                        upperAlarm: data.upperAlarm,
                        lowerAlarm: data.lowerAlarm
                    };
                })
                .catch(error => {
                    console.error('è·å–å›¾è¡¨é…ç½®å¤±è´¥:', error);
                    // è¿”å›é»˜è®¤é…ç½®
                    return {
                        yMin: 0, yMax: 100, baseValue: 50, upperAlarm: 80, lowerAlarm: 20
                    };
                });
        }

        // è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
        let requestQueue = [];
        let isProcessingQueue = false;
        const REQUEST_DELAY = 200; // è¯·æ±‚é—´éš”200ms

        // ä»æ•°æ®åº“è·å–å›¾è¡¨æ•°æ®
        async function getChartDataFromDB(param, type) {
            try {
                // æ£€æŸ¥æ•°æ®æºå¼€å…³ï¼Œå¦‚æœè®¾ç½®ä¸ºä½¿ç”¨æ¨¡æ‹Ÿå€¼ï¼Œç›´æ¥è¿”å›null
                if (!useRealData) {
                    console.log(`æ•°æ®æºè®¾ç½®ä¸ºæ¨¡æ‹Ÿå€¼ï¼Œè·³è¿‡æ•°æ®åº“æŸ¥è¯¢: ${param}-${type}`);
                    return null;
                }

                // è§£æå½“å‰é€‰æ‹©çš„ç£æ …å°ºä¿¡æ¯
                const parts = currentGrating.split('_');
                if (parts.length >= 4) {
                    const version = parts[0]; // G45 æˆ– G48
                    const channel = parts[2]; // 1, 2, 3, 4, 5
                    const side = parts[3]; // L æˆ– R

                    // å°†å‰ç«¯çš„typeè½¬æ¢ä¸ºåç«¯çš„chart_type
                    const chart_type = type === 'å¹³å‡å€¼' ? 'avg' : 'rag';

                    // æ·»åŠ åˆ°è¯·æ±‚é˜Ÿåˆ—è€Œä¸æ˜¯ç«‹å³å‘é€
                    return await queuedFetch(`/api/get_chart_data/${version}/${channel}/${param}/${chart_type}/${side}`, param, type);
                }

                return null; // è¿”å›nullè¡¨ç¤ºä½¿ç”¨é»˜è®¤æ•°æ®
            } catch (error) {
                console.error('è·å–æ•°æ®åº“å›¾è¡¨æ•°æ®å¤±è´¥:', error);
                return null;
            }
        }

        // é˜Ÿåˆ—åŒ–çš„fetchè¯·æ±‚
        async function queuedFetch(url, param, type) {
            return new Promise((resolve) => {
                requestQueue.push({
                    url,
                    param,
                    type,
                    resolve
                });

                processRequestQueue();
            });
        }

        // å¤„ç†è¯·æ±‚é˜Ÿåˆ—
        async function processRequestQueue() {
            if (isProcessingQueue || requestQueue.length === 0) {
                return;
            }

            isProcessingQueue = true;

            while (requestQueue.length > 0) {
                const request = requestQueue.shift();

                try {
                    const response = await fetch(request.url);
                    const data = await response.json();

                    if (data.status === 'success') {
                        if (data.data && data.data.length > 0) {
                            console.log(`ä»${data.source}è·å–åˆ°${request.param}-${request.type}å›¾è¡¨æ•°æ®:`, data.data.length, 'ä¸ªæ•°æ®ç‚¹');

                            // ç‰¹åˆ«è®°å½•P3LTå‚æ•°çš„æ•°æ®
                            if (request.param.toLowerCase() === 'p3lt') {
                                console.log(`ğŸ¯ P3LTæ•°æ®è¯¦æƒ…:`, {
                                    param: request.param,
                                    type: request.type,
                                    dataLength: data.data.length,
                                    firstThreePoints: data.data.slice(0, 3),
                                    source: data.source
                                });
                            }

                            request.resolve(data.data.map(point => point.y));
                        } else {
                            // æ•°æ®ä¸ºç©ºçš„æƒ…å†µ
                            console.log(`${request.param}-${request.type}: æ•°æ®åº“è¿æ¥å¤±è´¥æˆ–æ— æ•°æ®ï¼Œå›¾è¡¨å°†æ˜¾ç¤ºä¸ºç©º`);

                            // ç‰¹åˆ«è®°å½•P3LTå‚æ•°çš„ç©ºæ•°æ®æƒ…å†µ
                            if (request.param.toLowerCase() === 'p3lt') {
                                console.log(`ğŸ¯ P3LTæ•°æ®ä¸ºç©º:`, {
                                    param: request.param,
                                    type: request.type,
                                    response: data
                                });
                            }

                            request.resolve([]); // è¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯null
                        }
                    } else if (data.status === 'error') {
                        console.error('è·å–å›¾è¡¨æ•°æ®å¤±è´¥:', data.message);

                        // ç‰¹åˆ«è®°å½•P3LTå‚æ•°çš„é”™è¯¯æƒ…å†µ
                        if (request.param.toLowerCase() === 'p3lt') {
                            console.error(`ğŸ¯ P3LTæ•°æ®è·å–é”™è¯¯:`, {
                                param: request.param,
                                type: request.type,
                                error: data.message
                            });
                        }

                        request.resolve([]); // è¿”å›ç©ºæ•°ç»„è€Œä¸æ˜¯null
                    } else {
                        request.resolve([]);
                    }
                } catch (error) {
                    console.error('è¯·æ±‚å¤±è´¥:', error);
                    request.resolve(null);
                }

                // æ·»åŠ å»¶è¿Ÿï¼Œé¿å…è¿‡äºé¢‘ç¹çš„è¯·æ±‚
                if (requestQueue.length > 0) {
                    await new Promise(resolve => setTimeout(resolve, REQUEST_DELAY));
                }
            }

            isProcessingQueue = false;
        }
        
        
        
        // æ·»åŠ å‚è€ƒçº¿
        function addReferenceLines(chart, config) {
            // æ³¨å†Œæ’ä»¶æ¥ç»˜åˆ¶å‚è€ƒçº¿
            Chart.register({
                id: 'referenceLines',
                afterDraw: function(chart) {
                    if (currentGrating.includes('Channel') && chart.canvas.id.includes('avg')) {
                        const ctx = chart.ctx;
                        const chartArea = chart.chartArea;
                        const yScale = chart.scales.y;
                        
                        ctx.save();
                        
                        // è“è‰²è®¾å®šå€¼çº¿
                        const baseY = yScale.getPixelForValue(config.baseValue);
                        ctx.strokeStyle = '#3498db';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, baseY);
                        ctx.lineTo(chartArea.right, baseY);
                        ctx.stroke();
                        
                        // çº¢è‰²ä¸Šé™çº¿
                        const upperY = yScale.getPixelForValue(config.upperAlarm);
                        ctx.strokeStyle = '#e74c3c';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([]);
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, upperY);
                        ctx.lineTo(chartArea.right, upperY);
                        ctx.stroke();
                        
                        // çº¢è‰²ä¸‹é™çº¿
                        const lowerY = yScale.getPixelForValue(config.lowerAlarm);
                        ctx.strokeStyle = '#e74c3c';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([]);
                        ctx.beginPath();
                        ctx.moveTo(chartArea.left, lowerY);
                        ctx.lineTo(chartArea.right, lowerY);
                        ctx.stroke();
                        
                        ctx.restore();
                    }
                }
            });
        }
        
        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateChart() {
            fetch(`/api/get_data/${currentChannel}/${currentParameter}/${currentView}`)
                .then(response => response.json())
                .then(data => {
                    // ç¡®ä¿æœ‰50ä¸ªæ•°æ®ç‚¹
                    const chartData = Array(50).fill(0);
                    data.forEach((point, index) => {
                        if (index < 50) {
                            chartData[index] = point.y;
                        }
                    });
                    
                    chart.data.datasets[0].data = chartData;
                    chart.update('none');
                });
        }
        
        // æ›´æ–°å›¾è¡¨æ ‡é¢˜
        function updateChartTitle() {
            const title = `é€šé“${currentChannel} - ${currentParameter} - ${currentView === 'avg' ? 'å¹³å‡å€¼' : 'æå·®å€¼'}`;
            chart.options.plugins.title.text = title;
            chart.update('none');
        }
        
        // æ›´æ–°Yè½´èŒƒå›´ - ä¸åŸç¨‹åºè§„æ ¼ä¸€è‡´
        function updateYAxisRange() {
            let yMin, yMax;
            
            if (currentView === 'avg') {
                const ranges = {
                    'P1': [218.5, 221.5],
                    'P5U': [423.0, 427.0],
                    'P5L': [423.0, 427.0],
                    'P3': [642.0, 648.0],
                    'P4': [0.0, 2.0]
                };
                [yMin, yMax] = ranges[currentParameter] || [0, 100];
            } else {
                [yMin, yMax] = [0, 1.0];
            }
            
            chart.options.scales.y.min = yMin;
            chart.options.scales.y.max = yMax;
            chart.update('none');
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay(data) {
            const valueMap = {
                'P1': { avg: data.p1_avg, cpk: data.cpk_p1 },
                'P5U': { avg: data.p5u_avg, cpk: data.cpk_p5u },
                'P5L': { avg: data.p5l_avg, cpk: data.cpk_p5l },
                'P3': { avg: data.p3_avg, cpk: data.cpk_p3 },
                'P4': { avg: data.p4_avg, cpk: data.cpk_p4 }
            };
            
            if (currentParameter in valueMap) {
                const { avg, cpk } = valueMap[currentParameter];
                document.getElementById('cpkDisplay').textContent = `CPK: ${cpk.toFixed(2)}`;
                document.getElementById('currentValue').textContent = `å½“å‰å€¼: ${avg.toFixed(2)}`;
                
                // æ›´æ–°è§„æ ¼é™æ˜¾ç¤º
                const limits = getSpecLimits(currentParameter);
                document.getElementById('specLimits').textContent = `è§„æ ¼é™: ${limits.lsl} ~ ${limits.usl}`;

                // æ›´æ–°CPKé¢œè‰²
                const cpkElement = document.getElementById('cpkDisplay');
                if (cpk >= 1.33) {
                    cpkElement.style.color = '#27ae60';
                } else if (cpk >= 1.0) {
                    cpkElement.style.color = '#f39c12';
                } else {
                    cpkElement.style.color = '#e74c3c';
                }
            }

            // æ›´æ–°CPKé¢æ¿ä¸­çš„æ‰€æœ‰å€¼
            updateCPKPanel(data);
        }

        // æ›´æ–°CPKé¢æ¿
        function updateCPKPanel(data) {
            const cpkData = {
                'P1': data.cpk_p1,
                'P5U': data.cpk_p5u,
                'P5L': data.cpk_p5l,
                'P3': data.cpk_p3,
                'P4': data.cpk_p4
            };

            Object.keys(cpkData).forEach(param => {
                const cpk = cpkData[param];
                const valueElement = document.getElementById(`cpk${param}`);
                const statusElement = document.getElementById(`status${param}`);

                if (valueElement && statusElement) {
                    valueElement.textContent = cpk.toFixed(3);

                    // è®¾ç½®CPKå€¼é¢œè‰²å’ŒçŠ¶æ€
                    const { colorClass, statusText, statusClass } = getCPKStatus(cpk);
                    valueElement.className = `cpk-value ${colorClass}`;
                    statusElement.textContent = statusText;
                    statusElement.className = `cpk-status ${statusClass}`;
                }
            });
        }

        // è·å–CPKçŠ¶æ€
        function getCPKStatus(cpk) {
            if (cpk >= 1.33) {
                return {
                    colorClass: 'cpk-excellent',
                    statusText: 'ä¼˜ç§€',
                    statusClass: 'status-excellent'
                };
            } else if (cpk >= 1.0) {
                return {
                    colorClass: 'cpk-good',
                    statusText: 'è‰¯å¥½',
                    statusClass: 'status-good'
                };
            } else {
                return {
                    colorClass: 'cpk-poor',
                    statusText: 'éœ€æ”¹è¿›',
                    statusClass: 'status-poor'
                };
            }
        }

        // æ›´æ–°æ‰€æœ‰CPKå€¼ï¼ˆå½“æ‰“å¼€CPKé¢æ¿æ—¶è°ƒç”¨ï¼‰
        function updateAllCPKValues() {
            const currentSide = getCurrentSide();
            const currentVersion = getCurrentVersion();

            console.log(`æ›´æ–°æ‰€æœ‰CPKå€¼: ç‰ˆæœ¬=${currentVersion}, ä¾§é¢=${currentSide}`);

            // æ›´æ–°CPKé¢æ¿çš„ä¾§é¢æŒ‡ç¤ºå™¨å’Œæ ‡ç­¾
            updateCPKLabels(currentSide);

            // éœ€è¦è·å–æ‰€æœ‰5ä¸ªé€šé“çš„CPKæ•°æ®
            const channels = [1, 2, 3, 4, 5]; // P1, P5L, P5U, P3, P4
            const cpkPromises = channels.map(channel =>
                fetch(`/api/get_cpk_data/${currentVersion}/${channel}/${currentSide}`)
                    .then(response => response.json())
                    .then(data => ({ channel, data }))
                    .catch(error => {
                        console.error(`è·å–é€šé“${channel}çš„CPKæ•°æ®å¤±è´¥:`, error);
                        return { channel, data: { error: error.message } };
                    })
            );

            // ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ
            Promise.all(cpkPromises)
                .then(results => {
                    // åˆå¹¶æ‰€æœ‰é€šé“çš„CPKæ•°æ®
                    const allCpkData = {
                        cpk_p1: 0,
                        cpk_p5l: 0,
                        cpk_p5u: 0,
                        cpk_p3: 0,
                        cpk_p4: 0
                    };

                    results.forEach(result => {
                        const { channel, data } = result;
                        if (!data.error) {
                            // æ ¹æ®é€šé“å·æ˜ å°„åˆ°å¯¹åº”çš„CPKå­—æ®µ
                            if (channel === 1) allCpkData.cpk_p1 = data.cpk_p1 || 0;
                            else if (channel === 2) allCpkData.cpk_p5l = data.cpk_p5l || 0;
                            else if (channel === 3) allCpkData.cpk_p5u = data.cpk_p5u || 0;
                            else if (channel === 4) allCpkData.cpk_p3 = data.cpk_p3 || 0;
                            else if (channel === 5) allCpkData.cpk_p4 = data.cpk_p4 || 0;
                        } else {
                            console.warn(`é€šé“${channel}çš„CPKæ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼`);
                            // ä½¿ç”¨ç‰ˆæœ¬ç›¸å…³çš„æ¨¡æ‹Ÿæ•°æ®
                            const defaultValues = getDefaultCPKValues(currentVersion);
                            if (channel === 1) allCpkData.cpk_p1 = defaultValues.cpk_p1;
                            else if (channel === 2) allCpkData.cpk_p5l = defaultValues.cpk_p5l;
                            else if (channel === 3) allCpkData.cpk_p5u = defaultValues.cpk_p5u;
                            else if (channel === 4) allCpkData.cpk_p3 = defaultValues.cpk_p3;
                            else if (channel === 5) allCpkData.cpk_p4 = defaultValues.cpk_p4;
                        }
                    });

                    console.log('åˆå¹¶åçš„CPKæ•°æ®:', allCpkData);
                    updateCPKPanel(allCpkData);
                })
                .catch(error => {
                    console.error('è·å–CPKæ•°æ®å¤±è´¥:', error);
                    // ä½¿ç”¨ç‰ˆæœ¬ç›¸å…³çš„é»˜è®¤æ•°æ®
                    const defaultData = getDefaultCPKValues(currentVersion);
                    updateCPKPanel(defaultData);
                });
        }

        // æ›´æ–°CPKé¢æ¿çš„æ ‡ç­¾æ˜¾ç¤º
        function updateCPKLabels(currentSide) {
            // æ›´æ–°ä¾§é¢æŒ‡ç¤ºå™¨
            const sideIndicator = document.getElementById('cpkSideIndicator');
            if (sideIndicator) {
                sideIndicator.textContent = `${currentSide}ä¾§`;
            }

            // æ›´æ–°æ‰€æœ‰å‚æ•°æ ‡ç­¾
            const paramLabels = ['P1', 'P5U', 'P5L', 'P3', 'P4'];
            paramLabels.forEach(param => {
                const labelElement = document.getElementById(`label${param}`);
                if (labelElement) {
                    labelElement.textContent = `${currentSide}-${param}`;
                }
            });

            console.log(`CPKæ ‡ç­¾å·²æ›´æ–°ä¸º ${currentSide} ä¾§`);
        }

        // è·å–ç‰ˆæœ¬ç›¸å…³çš„é»˜è®¤CPKå€¼
        function getDefaultCPKValues(version) {
            if (version === 'G45') {
                return {
                    cpk_p1: 4.18,
                    cpk_p5l: 3.72,
                    cpk_p5u: 2.85,
                    cpk_p3: 1.95,
                    cpk_p4: 2.67
                };
            } else { // G48
                return {
                    cpk_p1: 2.50,
                    cpk_p5l: 1.88,
                    cpk_p5u: 2.15,
                    cpk_p3: 1.45,
                    cpk_p4: 1.92
                };
            }
        }

        // è·å–å½“å‰é€šé“
        function getCurrentChannel() {
            const activeBtn = document.querySelector('.selection-btn.active');
            if (activeBtn) {
                const text = activeBtn.textContent;
                if (text.includes('P1')) return 1;
                if (text.includes('P5L')) return 2;
                if (text.includes('P5U')) return 3;
                if (text.includes('P3')) return 4;
                if (text.includes('P4')) return 5;
            }
            return 1; // é»˜è®¤é€šé“1
        }

        // è·å–å½“å‰ä¾§é¢
        function getCurrentSide() {
            const activeBtn = document.querySelector('.selection-btn.active');
            if (activeBtn) {
                const text = activeBtn.textContent;
                if (text.includes('-L-')) return 'L';
                if (text.includes('-R-')) return 'R';
            }
            return 'L'; // é»˜è®¤å·¦ä¾§
        }

        // è·å–å½“å‰ç‰ˆæœ¬
        function getCurrentVersion() {
            const activeBtn = document.querySelector('.selection-btn.active');
            if (activeBtn) {
                const text = activeBtn.textContent;
                if (text.startsWith('G45')) return 'G45';
                if (text.startsWith('G48')) return 'G48';
            }
            return 'G45'; // é»˜è®¤G45
        }

        // æ›´æ–°çŠ¶æ€é¢æ¿ä¸­çš„CPKæ˜¾ç¤º
        function updateStatusCPK() {
            const currentChannel = getCurrentChannel();
            const currentSide = getCurrentSide();
            const currentVersion = getCurrentVersion();

            // å‘é€è¯·æ±‚è·å–å½“å‰å‚æ•°çš„CPKæ•°æ®
            fetch(`/api/get_cpk_data/${currentVersion}/${currentChannel}/${currentSide}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.error) {
                        // æ ¹æ®å½“å‰é€šé“æ›´æ–°å¯¹åº”çš„CPKæ˜¾ç¤º
                        let cpkValue = 0;
                        if (currentChannel === 1) cpkValue = data.cpk_p1;
                        else if (currentChannel === 2) cpkValue = data.cpk_p5l;
                        else if (currentChannel === 3) cpkValue = data.cpk_p5u;
                        else if (currentChannel === 4) cpkValue = data.cpk_p3;
                        else if (currentChannel === 5) cpkValue = data.cpk_p4;

                        // æ›´æ–°CPKæ˜¾ç¤º
                        const cpkElement = document.getElementById('cpkDisplay');
                        cpkElement.textContent = `CPK: ${cpkValue.toFixed(2)}`;

                        // æ›´æ–°CPKé¢œè‰²
                        if (cpkValue >= 1.33) {
                            cpkElement.style.color = '#27ae60';
                        } else if (cpkValue >= 1.0) {
                            cpkElement.style.color = '#f39c12';
                        } else {
                            cpkElement.style.color = '#e74c3c';
                        }

                        console.log(`çŠ¶æ€é¢æ¿CPKå·²æ›´æ–°: ${cpkValue.toFixed(2)} (ç‰ˆæœ¬: ${currentVersion}, é€šé“: ${currentChannel})`);
                    }
                })
                .catch(error => {
                    console.error('æ›´æ–°çŠ¶æ€CPKå¤±è´¥:', error);
                });
        }
        
        // è·å–è§„æ ¼é™ - ä¸åŸç¨‹åºé…ç½®ä¸€è‡´
        function getSpecLimits(parameter) {
            const limits = {
                'P1': { lsl: 219.10, usl: 220.90 },
                'P5U': { lsl: 423.0, usl: 427.0 },
                'P5L': { lsl: 423.0, usl: 427.0 },
                'P3': { lsl: 643.0, usl: 647.0 },
                'P4': { lsl: 0.0, usl: 2.0 }
            };
            return limits[parameter] || { lsl: 0, usl: 100 };
        }
        
        // æ˜¾ç¤ºæŠ¥è­¦
        function showAlarm(message) {
            const alarmArea = document.getElementById('alarmArea');
            const alarmDiv = document.createElement('div');
            alarmDiv.className = 'alarm-message';
            alarmDiv.textContent = message;
            
            alarmArea.appendChild(alarmDiv);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤æŠ¥è­¦
            setTimeout(() => {
                if (alarmDiv.parentNode) {
                    alarmDiv.parentNode.removeChild(alarmDiv);
                }
            }, 5000);
        }
        
        // æ›´æ–°æ—¶é—´æ˜¾ç¤º
        function updateTimeDisplay() {
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('timeDisplay').textContent = timeString;
        }
        
        // æ›´æ–°çŠ¶æ€æ–‡æœ¬
        function updateStatusText(text) {
            document.getElementById('statusText').textContent = text;
        }

        // æ›´æ–°é¡µé¢æ ‡é¢˜ (ç‰ˆæœ¬åˆ‡æ¢æ—¶ä½¿ç”¨)
        function updatePageTitle(version) {
            // æ›´æ–°æµè§ˆå™¨æ ‡é¢˜
            document.title = `${version}-L-P1Xå…‰æ …æµ‹é‡ç³»ç»Ÿ - Webç‰ˆ`;

            // æ›´æ–°å·¦ä¸Šè§’çš„æ ‡é¢˜æ–‡æœ¬
            const titleElement = document.querySelector('.title-text');
            if (titleElement) {
                titleElement.textContent = `${version}-L-P1Xå…‰æ …æµ‹é‡ç³»ç»Ÿ - Webç‰ˆ`;
            }
        }

        // æ›´æ–°ç£æ …å°ºé€‰æ‹©æ ‡é¢˜ (ç£æ …å°ºé€‰æ‹©æ—¶ä½¿ç”¨)
        function updateGratingTitle(gratingName) {
            // æ›´æ–°æµè§ˆå™¨æ ‡é¢˜
            document.title = `${gratingName}å…‰æ …æµ‹é‡ç³»ç»Ÿ - Webç‰ˆ`;

            // æ›´æ–°å·¦ä¸Šè§’çš„æ ‡é¢˜æ–‡æœ¬
            const titleElement = document.querySelector('.title-text');
            if (titleElement) {
                titleElement.textContent = `${gratingName}å…‰æ …æµ‹é‡ç³»ç»Ÿ - Webç‰ˆ`;
            }
        }

        // æ•°æ®æºæ§åˆ¶
        let useRealData = true; // é»˜è®¤ä½¿ç”¨å®é™…æ•°æ®

        // ç›‘å¬æ¥è‡ªé…ç½®é¡µé¢çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'dataSourceChanged') {
                useRealData = event.data.useRealData;
                console.log('æ•°æ®æºå·²åˆ‡æ¢:', useRealData ? 'å®é™…å€¼' : 'æ¨¡æ‹Ÿå€¼');

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateDataSourceStatus();

                // åˆ·æ–°å½“å‰å›¾è¡¨
                refreshCurrentChart();
            }
        });

        // æ›´æ–°æ•°æ®æºçŠ¶æ€æ˜¾ç¤º
        function updateDataSourceStatus() {
            const statusElement = document.getElementById('statusText');
            if (statusElement) {
                const currentStatus = statusElement.textContent;
                const dataSourceText = useRealData ? 'å®é™…å€¼' : 'æ¨¡æ‹Ÿå€¼';

                // å¦‚æœçŠ¶æ€æ–‡æœ¬ä¸­æ²¡æœ‰æ•°æ®æºä¿¡æ¯ï¼Œæ·»åŠ å®ƒ
                if (!currentStatus.includes('æ•°æ®æº:')) {
                    statusElement.textContent = `${currentStatus} | æ•°æ®æº: ${dataSourceText}`;
                } else {
                    // æ›´æ–°ç°æœ‰çš„æ•°æ®æºä¿¡æ¯
                    statusElement.textContent = currentStatus.replace(/æ•°æ®æº: (å®é™…å€¼|æ¨¡æ‹Ÿå€¼)/, `æ•°æ®æº: ${dataSourceText}`);
                }
            }
        }

        // åˆ·æ–°å½“å‰å›¾è¡¨
        function refreshCurrentChart() {
            // é‡æ–°åŠ è½½æ‰€æœ‰å›¾è¡¨æ•°æ®
            loadAllCharts();
        }
    </script>
</body>
</html>














